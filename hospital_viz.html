<!DOCTYPE html>
<html>
<head>
    <title>KEGG Pathway Visualizer</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/panzoom@9.4.3/dist/panzoom.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f5f5f5;
        }
        
        #header {
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #main-container {
            display: flex;
            height: calc(100vh - 50px);
        }
        
        #pathway-container {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            background-color: white;
        }
        
        #diagram {
            width: 100%;
            height: 100%;
            min-width: 2000px;
            min-height: 2000px;
            background-color: white;
        }
        
        #controls {
            width: 300px;
            background-color: white;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            padding: 15px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        }
        
        .control-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .control-section h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .checkbox-label {
            display: block;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        #node-info {
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }
        
        #zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        #zoom-controls button {
            width: 40px;
            height: 40px;
            border: none;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Custom Mermaid styles */
        .mermaid .node rect {
            stroke-width: 2px;
        }
        .mermaid .node.source rect {
            fill: #ffcccc;
            stroke: #cc0000;
        }
        .mermaid .node.sink rect {
            fill: #ccffcc;
            stroke: #00cc00;
        }
        .mermaid .node.sanitizer rect {
            fill: #ccccff;
            stroke: #0000cc;
        }
        .mermaid .node.normal rect {
            fill: #eeeeee;
            stroke: #888;
        }
        .mermaid .node.suspicious rect {
            stroke: red !important;
            stroke-width: 2px !important;
            stroke-dasharray: 5 !important;
        }
        .mermaid .edgeLabel {
            background: white;
            padding: 0 3px;
            font-size: 12px;
        }
        .mermaid .cluster rect {
            fill: rgba(200, 200, 255, 0.2);
            stroke: rgba(0, 0, 255, 0.3);
            stroke-width: 1px;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 18px;
        }
        
        .suspicious-item {
            background: #ffebee;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 4px solid #f44336;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>KEGG Pathway Visualizer</h1>
    </div>
    
    <div id="main-container">
        <div id="pathway-container">
            <div id="diagram" class="mermaid"></div>
            
            <div id="zoom-controls">
                <button id="zoom-in">+</button>
                <button id="zoom-out">-</button>
                <button id="reset-zoom">↻</button>
            </div>
        </div>
        
        <div id="controls">
            <div class="control-section">
                <h3>Display Options</h3>
                <label class="checkbox-label">
                    <input type="checkbox" id="toggleSanitizers" checked> Show Sanitizers
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="toggleSuspicious" checked> Highlight Sensitive Flows
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="toggleNormalNodes" checked> Show Normal Nodes
                </label>
            </div>
            
            <div class="control-section">
                <h3>Node Information</h3>
                <div id="node-info">
                    Click on any node or edge to see details
                </div>
            </div>
            
            <div class="control-section">
                <h3>Detected Issues</h3>
                <div id="suspiciousList">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>
    
    <div id="loading">Loading pathway data...</div>

<script>
    // Initialize Mermaid with custom configuration
    mermaid.initialize({
        startOnLoad: false,
        theme: 'default',
        securityLevel: 'loose',
        maxTextSize: 1000000,
        flowchart: {
            useMaxWidth: false,
            htmlLabels: true,
            curve: 'basis'
        },
        maxEdges: 5000,
        maxNodes: 5000
    });

    // Global variables
    let allNodes = [];
    let allEdges = [];
    let sensitiveNodes = [];
    let panzoomInstance = null;
    let currentActiveElement = null;

    // Color scheme
    const COLORS = {
        source: '#ffcccc',
        sink: '#ccffcc',
        sanitizer: '#ccccff',
        normal: '#eeeeee',
        sensitive: '#ff9999',
        edge: '#888'
    };

    // Parse GraphML data
    function parseGraphML(graphmlText) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(graphmlText, "text/xml");

        const nodes = [];
        const edges = [];
        const sensitiveNodes = [];

        // Parse nodes
        const nodeElements = xmlDoc.getElementsByTagName("node");
        for (let node of nodeElements) {
            const id = node.getAttribute("id");
            const dataElements = node.getElementsByTagName("data");
            let type = "normal";
            let name = id;
            let keggid = "";

            for (let data of dataElements) {
                const key = data.getAttribute("key");
                if (key === "type") {
                    // Not using type for now since all are compounds in the sample
                } else if (key === "class") {
                    type = data.textContent;
                } else if (key === "name") {
                    name = data.textContent === "none" ? id : data.textContent;
                } else if (key === "keggid") {
                    keggid = data.textContent;
                }
            }

            nodes.push({
                id,
                name,
                type,
                keggid
            });

            if (type === "sanitizer") {
                sensitiveNodes.push(id);
            }
        }

        // Parse edges
        const edgeElements = xmlDoc.getElementsByTagName("edge");
        for (let edge of edgeElements) {
            const source = edge.getAttribute("source");
            const target = edge.getAttribute("target");
            const dataElements = edge.getElementsByTagName("data");
            let label = "";

            for (let data of dataElements) {
                const key = data.getAttribute("key");
                if (key === "label") {
                    label = data.textContent;
                }
            }

            edges.push({
                source,
                target,
                label
            });
        }

        return { nodes, edges, sensitiveNodes };
    }

    // Generate Mermaid diagram from parsed data
    function generateKeggDiagram(graphData) {
        let diagram = 'flowchart LR\n';
        const suspiciousItems = [];

        // Group nodes by type for better organization
        diagram += '    subgraph Sources[Sources]\n';
        graphData.nodes.filter(node => node.type === 'source').forEach(node => {
            const safeName = sanitizeId(node.id);
            diagram += `        ${safeName}["${node.name}"]:::source\n`;
        });
        diagram += '    end\n\n';

        diagram += '    subgraph Sinks[Sinks]\n';
        graphData.nodes.filter(node => node.type === 'sink').forEach(node => {
            const safeName = sanitizeId(node.id);
            diagram += `        ${safeName}["${node.name}"]:::sink\n`;
        });
        diagram += '    end\n\n';

        diagram += '    subgraph Sanitizers[Sanitizers]\n';
        graphData.nodes.filter(node => node.type === 'sanitizer').forEach(node => {
            const safeName = sanitizeId(node.id);
            diagram += `        ${safeName}["${node.name}"]:::sanitizer\n`;
            suspiciousItems.push(node.name);
        });
        diagram += '    end\n\n';

        // Add normal nodes
        graphData.nodes.filter(node => node.type === 'normal').forEach(node => {
            const safeName = sanitizeId(node.id);
            diagram += `    ${safeName}["${node.name}"]:::normal\n`;
        });

        // Process edges with interaction labels
        graphData.edges.forEach(edge => {
            const safeFrom = sanitizeId(edge.source);
            const safeTo = sanitizeId(edge.target);
            // Skip empty labels to avoid Mermaid parsing errors
            const label = edge.label ? `|${edge.label}|` : '';
            diagram += `    ${safeFrom} -->${label} ${safeTo}\n`;
        });

        // Mark sensitive nodes
        graphData.sensitiveNodes.forEach(nodeId => {
            const safeNode = sanitizeId(nodeId);
            diagram += `    ${safeNode}:::suspicious\n`;
        });

        // Add custom styles
        diagram += `
                classDef source fill:#ffcccc,stroke:#cc0000,stroke-width:2px;
                classDef sink fill:#ccffcc,stroke:#00cc00,stroke-width:2px;
                classDef sanitizer fill:#ccccff,stroke:#0000cc,stroke-width:2px;
                classDef normal fill:#eeeeee,stroke:#888,stroke-width:1px;
                classDef suspicious stroke:red,stroke-width:2px,stroke-dasharray:5;
            `;

        return { diagram, suspiciousItems };
    }

    // Sanitize IDs for Mermaid
    function sanitizeId(id) {
        return id.replace(/[^a-zA-Z0-9_]/g, '_');
    }

    // Update issues list
    function updateIssuesList(items) {
        const issuesList = document.getElementById('suspiciousList');
        issuesList.innerHTML = items.map(item => `
                <div class="suspicious-item">
                    <strong>${item}</strong>
                    <div>Potential drug target</div>
                </div>
            `).join('');
    }

    // Setup diagram interactivity
    function setupDiagramInteractivity() {
        const diagramContainer = document.getElementById('diagram');
        const svg = diagramContainer.querySelector('svg');

        if (!svg) return;

        // Add hover effects
        svg.querySelectorAll('.node, .edgeLabel').forEach(element => {
            element.style.cursor = 'pointer';
            
            element.addEventListener('click', function() {
                if (this.classList.contains('node')) {
                    const title = this.querySelector('title');
                    const nodeId = title ? title.textContent : 'Unknown';
                    const nodeType = this.classList.contains('source') ? 'Source (Compound)' :
                        this.classList.contains('sink') ? 'Sink (Pathway)' :
                            this.classList.contains('sanitizer') ? 'Sanitizer (Enzyme)' : 'Normal Node';

                    let details = `Node: ${nodeId}\nType: ${nodeType}`;
                    if (this.classList.contains('suspicious')) {
                        details += '\n⚠️ Sensitive compound';
                    }

                    // Find connected edges
                    const connectedEdges = allEdges.filter(edge => 
                        edge.source === nodeId || edge.target === nodeId
                    );
                    
                    if (connectedEdges.length > 0) {
                        details += '\n\nConnected to:';
                        connectedEdges.forEach(edge => {
                            const otherNodeId = edge.source === nodeId ? edge.target : edge.source;
                            const otherNode = allNodes.find(n => n.id === otherNodeId);
                            const direction = edge.source === nodeId ? '→' : '←';
                            
                            if (otherNode) {
                                details += `\n${direction} ${otherNode.name} (${edge.label || 'interaction'})`;
                            }
                        });
                    }

                    document.getElementById('node-info').textContent = details;
                    
                    // Highlight the clicked node
                    if (currentActiveElement) {
                        currentActiveElement.style.filter = '';
                    }
                    this.style.filter = 'drop-shadow(0 0 8px rgba(52, 152, 219, 0.8))';
                    currentActiveElement = this;
                    
                } else if (this.classList.contains('edgeLabel')) {
                    const textElement = this.querySelector('text');
                    const interaction = textElement ? textElement.textContent : 'Unknown interaction';
                    const pathId = this.parentNode.id.replace('-edge-label', '');
                    const path = svg.querySelector(`#${pathId}`);

                    if (path) {
                        const sourceTitle = path.getAttribute('data-source-title');
                        const targetTitle = path.getAttribute('data-target-title');
                        document.getElementById('node-info').textContent = 
                            `Interaction: ${interaction}\nFrom: ${sourceTitle || 'Unknown'}\nTo: ${targetTitle || 'Unknown'}`;
                    }
                }
            });
        });
        
        // Initialize panzoom after diagram is rendered
        initPanzoom();
    }

    // Initialize panzoom functionality
    function initPanzoom() {
        const container = document.getElementById('pathway-container');
        
        // Remove previous instance if exists
        if (panzoomInstance) {
            panzoomInstance.dispose();
        }
        
        panzoomInstance = panzoom(container, {
            bounds: true,
            boundsPadding: 0.1,
            maxZoom: 5,
            minZoom: 0.5
        });
    }

    // Setup zoom controls
    function setupZoomControls() {
        document.getElementById('zoom-in').addEventListener('click', () => {
            if (panzoomInstance) panzoomInstance.smoothZoom(0, 0, 1.2);
        });
        
        document.getElementById('zoom-out').addEventListener('click', () => {
            if (panzoomInstance) panzoomInstance.smoothZoom(0, 0, 0.8);
        });
        
        document.getElementById('reset-zoom').addEventListener('click', () => {
            if (panzoomInstance) {
                panzoomInstance.moveTo(0, 0);
                panzoomInstance.zoomAbs(0, 0, 1);
            }
        });
    }

    // Load and render the pathway
    async function loadAndRenderPathway() {
        try {
            document.getElementById('loading').style.display = 'flex';
            
            // Load the GraphML file
            const response = await fetch('pathways.graphml');
            if (!response.ok) throw new Error(`Failed to load GraphML: ${response.status}`);

            const graphmlText = await response.text();
            const graphData = parseGraphML(graphmlText);

            allNodes = graphData.nodes;
            allEdges = graphData.edges;
            sensitiveNodes = graphData.sensitiveNodes;

            // Generate and render the diagram
            const { diagram, suspiciousItems } = generateKeggDiagram(graphData);
            const container = document.getElementById('diagram');
            
            container.innerHTML = diagram;
            container.className = 'mermaid';

            // Initialize Mermaid rendering
            await mermaid.run({
                querySelector: '#diagram',
                suppressErrors: false
            });

            // Setup interactivity
            setupDiagramInteractivity();
            setupZoomControls();
            
            // Update the issues list
            updateIssuesList(suspiciousItems);

        } catch (error) {
            console.error('Error loading pathway:', error);
            document.getElementById('diagram').innerHTML = `
                <div style="color:red; padding:20px;">
                    <h3>Error Loading Pathway</h3>
                    <p>${error.message}</p>
                </div>
            `;
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // Initialize the visualization
    document.addEventListener('DOMContentLoaded', () => {
        loadAndRenderPathway();
        
        // Setup display control event listeners
        document.getElementById('toggleSanitizers').addEventListener('change', loadAndRenderPathway);
        document.getElementById('toggleSuspicious').addEventListener('change', loadAndRenderPathway);
        document.getElementById('toggleNormalNodes').addEventListener('change', loadAndRenderPathway);
    });
</script>
</body>
</html>